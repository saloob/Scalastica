(function(){var i;i=function(a){this._ice=a;this._tmpNode=null;this._tmpNodeTagName="icepaste";this._pasteId="icepastediv";var b=this;this.pasteType="formattedClean";this.preserve="p";this.beforePasteClean=function(a){return a};this.afterPasteClean=function(a){return a};a.element.oncopy=function(){return b.handleCopy.apply(b)}};i.prototype={setSettings:function(a){a=a||{};ice.dom.extend(this,a);this.preserve+=","+this._tmpNodeTagName;this.setupPreserved()},keyDown:function(a){if(!(!0!==a.metaKey&&
!0!==a.ctrlKey))return 86==a.keyCode?this.handlePaste():88==a.keyCode&&this.handleCut(),!0},keyPress:function(a){var b=null;null==a.which?b=String.fromCharCode(a.keyCode):0<a.which&&(b=String.fromCharCode(a.which));this.cutElement&&"x"===b?ice.dom.isBrowser("webkit")&&this.cutElement.focus():"v"===b&&ice.dom.isBrowser("webkit")&&document.getElementById(this._pasteId).focus();return!0},handleCopy:function(){},handlePaste:function(){var a=this._ice.getCurrentRange();a.collapsed||(this._ice.isTracking?
(this._ice.deleteContents(),a=a.cloneRange()):(a.deleteContents(),a.collapse(!0)));this._ice.isTracking&&this._ice._moveRangeToValidTrackingPos(a);if(a.startContainer==this._ice.element){var b=ice.dom.find(this._ice.element,this._ice.blockEl)[0];b||(b=ice.dom.create("<"+this._ice.blockEl+" ><br/></"+this._ice.blockEl+">"),this._ice.element.appendChild(b));a.setStart(b,0);a.collapse(!0);this._ice.env.selection.addRange(a)}this._tmpNode=this._ice.env.document.createElement(this._tmpNodeTagName);a.insertNode(this._tmpNode);
switch(this.pasteType){case "formatted":this.setupPaste();break;case "formattedClean":this.setupPaste(!0)}return!0},setupPaste:function(a){var b=this.createDiv(this._pasteId),c=this;b.onpaste=function(){setTimeout(function(){c.handlePasteValue(a)},0)};this._ice.env.frame?ice.dom.isBrowser("webkit")?(b.blur(),setTimeout(function(){b.focus()},0)):b.focus():b.focus();return!0},handlePasteValue:function(a){var b=ice.dom.getHtml(document.getElementById(this._pasteId)),c=ice.dom.children("<div>"+b+"</div>",
this._ice.blockEl);1===c.length&&ice.dom.getNodeTextContent("<div>"+b+"</div>")===ice.dom.getNodeTextContent(c)&&(b=ice.dom.getHtml(b));b=this.beforePasteClean.call(this,b);a&&(b=this._ice.getCleanContent(b),b=this.stripPaste(b));var b=this.afterPasteClean.call(this,b),b=ice.dom.trim(b),d=this._ice.getCurrentRange();d.setStartAfter(this._tmpNode);d.collapse(!0);var e=c=a=null,b=d.createContextualFragment(b),f=this._ice.startBatchChange();if(ice.dom.hasBlockChildren(b)){e=ice.dom.isChildOfTagName(this._tmpNode,
this._ice.blockEl);d.setEndAfter(e.lastChild);this._ice.selection.addRange(d);var h=d.extractContents(),g=this._ice.env.document.createElement(this._ice.blockEl);g.appendChild(h);ice.dom.insertAfter(e,g);d.setStart(g,0);d.collapse(!0);this._ice.selection.addRange(d);for(d=d.startContainer;b.firstChild;)3===b.firstChild.nodeType&&!jQuery.trim(b.firstChild.nodeValue)?b.removeChild(b.firstChild):ice.dom.isBlockElement(b.firstChild)?(""!==b.firstChild.textContent&&(c=a=null,this._ice.isTracking?(c=this._ice.createIceNode("insertType"),
this._ice.addChange("insertType",[c]),e=document.createElement(b.firstChild.tagName),c.innerHTML=b.firstChild.innerHTML,e.appendChild(c)):(c=e=document.createElement(b.firstChild.tagName),e.innerHTML=b.firstChild.innerHTML),ice.dom.insertBefore(d,e)),b.removeChild(b.firstChild)):(a||(e=document.createElement(this._ice.blockEl),ice.dom.insertBefore(d,e),this._ice.isTracking?(a=this._ice.createIceNode("insertType"),this._ice.addChange("insertType",[a]),e.appendChild(a)):a=e),c=a,a.appendChild(b.removeChild(b.firstChild)));
g.textContent||g.parentNode.removeChild(g)}else if(this._ice.isTracking)e=this._ice.createIceNode("insertType",b),this._ice.addChange("insertType",[e]),d.insertNode(e),c=e;else for(;a=b.firstChild;)d.insertNode(a),d.setStartAfter(a),d.collapse(!0),c=a;this._ice.endBatchChange(f);this._cleanup(c)},createDiv:function(a){var b=ice.dom.getId(a);b&&ice.dom.remove(b);b=this._ice.env.document.createElement("div");b.id=a;b.setAttribute("contentEditable",!0);ice.dom.setStyle(b,"width","1px");ice.dom.setStyle(b,
"height","1px");ice.dom.setStyle(b,"overflow","hidden");ice.dom.setStyle(b,"position","fixed");ice.dom.setStyle(b,"top","10px");ice.dom.setStyle(b,"left","10px");document.body.appendChild(b);return b},handleCut:function(){this.cutElementId="icecut";this.cutElement=this.createDiv(this.cutElementId);var a=this._ice.getCurrentRange();if(!a.collapsed){var b=a.getHTMLContents();this._ice.isTracking?this._ice.deleteContents():a.deleteContents();var c=document.createRange();this.cutElement.innerHTML=b;c.setStart(this.cutElement.firstChild,
0);c.setEndAfter(this.cutElement.lastChild);var d=this;this._ice.env.frame?setTimeout(function(){d.cutElement.focus();setTimeout(function(){ice.dom.remove(d.cutElement);a.setStart(a.startContainer,a.startOffset);a.collapse(!1);d._ice.env.selection.addRange(a);d._ice.env.frame?d._ice.env.frame.contentWindow.focus():d._ice.element.focus()},100)},0):(setTimeout(function(){d.cutElement.focus();setTimeout(function(){a.setStart(a.startContainer,a.startOffset);a.collapse(!1);d._ice.env.selection.addRange(a);
d._ice.env.frame?d._ice.env.frame.contentWindow.focus():d._ice.element.focus()},100)},0),"chrome"===ice.dom.getWebkitType()&&d.cutElement.focus());d._ice.env.selection.addRange(c)}},stripPaste:function(a){a=this._cleanWordPaste(a);return a=this.cleanPreserved(a)},setupPreserved:function(){var a=this;this._tags="";this._attributesMap=[];ice.dom.each(this.preserve.split(","),function(b,c){c.match(/(\w+)(\[(.+)\])?/);var d=RegExp.$1,e=RegExp.$3;a._tags&&(a._tags+=",");a._tags+=d.toLowerCase();a._attributesMap[d]=
e.split("|")})},cleanPreserved:function(a){var b=this,c=this._ice.env.document.createElement("div");c.innerHTML=a;c=ice.dom.stripEnclosingTags(c,this._tags);ice.dom.each(ice.dom.find(c,this._tags),function(a,c){if(ice.dom.hasClass(c,"skip-clean"))return!0;var f=c.tagName.toLowerCase(),f=b._attributesMap[f];if(f[0]&&"*"===f[0])return!0;if(c.hasAttributes())for(var h=c.attributes,a=h.length-1;0<=a;a--)ice.dom.inArray(h[a].name,f)||c.removeAttribute(h[a].name)});return c.innerHTML},_cleanWordPaste:function(a){a=
a.replace(/<(meta|link)[^>]+>/g,"");a=a.replace(/<\!--(.|\s)*?--\>/g,"");a=a.replace(/<style>[\s\S]*?<\/style>/g,"");a=a.replace(/<\/?\w+:[^>]*>/gi,"");a=a.replace(/<\\?\?xml[^>]*>/gi,"");a=this._cleanPaste(a);return a=a.replace(/<(\w[^>]*) (lang)=([^ |>]*)([^>]*)/gi,"<$1$4")},_cleanPaste:function(a){a=a.replace(/<b(\s+|>)/g,"<strong$1");a=a.replace(/<\/b(\s+|>)/g,"</strong$1");a=a.replace(/<i(\s+|>)/g,"<em$1");return a=a.replace(/<\/i(\s+|>)/g,"</em$1")},_cleanup:function(a){try{var a=a&&a.lastChild||
a||this._tmpNode,b=this._ice.getCurrentRange();b.setStartAfter(a);b.collapse(!0);this._ice.selection.addRange(b);this._ice.env.frame?this._ice.env.frame.contentWindow.focus():this._ice.element.focus();this._tmpNode.parentNode.removeChild(this._tmpNode);this._tmpNode=null;for(var c=this._ice.env.document.getElementsByClassName(this._ice.changeTypes.insertType.alias),a=0;a<c.length;a++)c[a].textContent||c[a].parentNode&&c[a].parentNode.removeChild(c[a])}catch(d){window.console&&console.error(d)}}};
ice.dom.noInclusionInherits(i,ice.IcePlugin);this._plugin.IceCopyPastePlugin=i}).call(this.ice);